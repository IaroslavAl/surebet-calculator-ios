name: Release App Store Connect

on:
  workflow_dispatch:
    inputs:
      marketing_version:
        description: "Optional marketing version (example: 1.8.0). If empty, keep current version."
        required: false
        type: string
      auto_bump_patch:
        description: "Auto bump patch marketing version (X.Y.Z -> X.Y.Z+1) when marketing_version is empty."
        required: false
        default: false
        type: boolean
      build_number:
        description: "Optional build number override (digits only)."
        required: false
        type: string
      run_ui_tests:
        description: "Run optional UI tests before release build."
        required: false
        default: false
        type: boolean

permissions:
  contents: read

concurrency:
  group: release-app-store-${{ github.ref }}
  cancel-in-progress: false

env:
  XCODE_VERSION: latest

jobs:
  release-unit-tests:
    name: Release Unit Tests
    runs-on: macos-latest
    env:
      APPMETRICA_API_KEY: ${{ secrets.APPMETRICA_API_KEY }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Select Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ env.XCODE_VERSION }}

      - name: Print Xcode version
        run: xcodebuild -version

      - name: Run unit tests
        run: ./scripts/ci/xcode_ci.sh test

  release-ui-tests:
    name: Release UI Tests
    if: ${{ inputs.run_ui_tests == true }}
    needs:
      - release-unit-tests
    runs-on: macos-latest
    env:
      APPMETRICA_API_KEY: ${{ secrets.APPMETRICA_API_KEY }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Select Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ env.XCODE_VERSION }}

      - name: Print Xcode version
        run: xcodebuild -version

      - name: Run UI tests
        run: ./scripts/ci/xcode_ci.sh test-ui

  release-app-store:
    name: Release App Store Build
    needs:
      - release-unit-tests
      - release-ui-tests
    if: ${{ always() && needs.release-unit-tests.result == 'success' && (needs.release-ui-tests.result == 'success' || needs.release-ui-tests.result == 'skipped') }}
    runs-on: macos-latest
    env:
      APPMETRICA_API_KEY: ${{ secrets.APPMETRICA_API_KEY }}
      APP_STORE_CONNECT_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
      APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
      APP_STORE_CONNECT_API_KEY: ${{ secrets.APP_STORE_CONNECT_API_KEY }}
      IOS_DISTRIBUTION_CERT_BASE64: ${{ secrets.IOS_DISTRIBUTION_CERT_BASE64 }}
      IOS_DISTRIBUTION_CERT_PASSWORD: ${{ secrets.IOS_DISTRIBUTION_CERT_PASSWORD }}
      IOS_PROVISIONING_PROFILE_BASE64: ${{ secrets.IOS_PROVISIONING_PROFILE_BASE64 }}
      KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
      MARKETING_VERSION_INPUT: ${{ inputs.marketing_version }}
      AUTO_BUMP_PATCH: ${{ inputs.auto_bump_patch }}
      BUILD_NUMBER_OVERRIDE: ${{ inputs.build_number }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Select Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ env.XCODE_VERSION }}

      - name: Print Xcode version
        run: xcodebuild -version

      - name: Archive and upload build to App Store Connect
        run: ./scripts/ci/release_app_store.sh

      - name: Upload release artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: app-store-release-${{ github.run_number }}
          path: |
            ${{ runner.temp }}/surebet-calculator.xcarchive
            ${{ runner.temp }}/export/*.ipa
          if-no-files-found: warn
