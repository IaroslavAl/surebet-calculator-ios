# INCIDENTS AND LESSONS

Формат записи:
- Дата
- Симптом
- Корневая причина
- Исправление
- Guardrail (правило на будущее)

## 2026-02-01 — Потеря transition при закрытии онбординга
- Симптом: `.move(edge: .bottom)` работал нестабильно.
- Корневая причина: анимировался контейнер, а не overlay-слой.
- Исправление: базовый экран всегда в иерархии, transition только на слое онбординга.
- Guardrail: не анимировать целый контейнер для локального перехода overlay.

## 2026-02-08 — AttributeGraph cycle и зависание интерактивности после онбординга
- Симптом: после закрытия онбординга меню визуально показывается, но нажатия не работают; в логах повторяется `AttributeGraph: cycle detected ...`.
- Корневая причина: `SurebetCalculatorViewModel` создавался прямо в `NavigationLink` destination builder, из-за чего на iOS 16 destination переинициализировался и запускал цикл обновлений SwiftUI.
- Исправление: вынести владение VM в отдельный container view с `@StateObject`, а в `SurebetCalculatorView` использовать `@ObservedObject`.
- Guardrail: для экранов, открываемых через `NavigationLink`, не создавать `ObservableObject` напрямую в destination builder; владелец VM должен быть стабильным (`@StateObject` в контейнере).

## 2026-02-08 — Severe hang на iPhone при вводе в калькулятор
- Симптом: на iPhone фиксировались зависания интерфейса на несколько секунд (`Severe Hang`, `Gesture: System gesture gate timed out`), особенно во время ввода в поля и пересчета строк.
- Корневая причина: перегрузка main thread в hot-path ввода: синхронный `calculate()` в `send(_:)` на каждое нажатие, лишние пересчеты при no-op, избыточные `@Published`-апдейты root ViewModel и повторный парсинг/повторные проходы в калькуляторе.
- Исправление: оставить ViewModel на `@MainActor`, но сократить нагрузку: убрать лишние `@Published` из внутреннего состояния, добавить short-circuit для no-op действий до `calculate()`, оптимизировать `Calculator` через кэш коэффициентов и суммы обратных коэффициентов в рамках одного расчета, убрать лишний callback в `TextField`-биндинге.
- Guardrail: `@MainActor`-изоляция ViewModel допустима и обязательна, но обработчики частых UI-событий должны быть константно-легкими и не инициировать повторные вычисления/перерисовки без фактической смены состояния.

## 2026-01-27 — Race condition в MockURLProtocol
- Симптом: флаки сетевых тестов.
- Корневая причина: глобальный handler перезаписывался параллельно.
- Исправление: потокобезопасный реестр по `URL.absoluteString`.
- Guardrail: уникальные полные URL и отсутствие shared глобального mutable handler.

## 2026-01-27 — Неверная стратегия подавления Sendable warning
- Симптом: попытка глушить `sendable` через SwiftLint.
- Корневая причина: warning компилятора Swift, не линтера.
- Исправление: корректная Sendable-конформность типов.
- Guardrail: сначала определять источник warning (compiler vs linter).

## 2026-01-24 — Нестабильность accessibilityIdentifier в UI-тестах
- Симптом: XCUITest не находил кастомные элементы.
- Корневая причина: идентификатор не всегда пробрасывался на нужный UI-элемент.
- Исправление: поиск по тексту кнопки/иконке.
- Guardrail: в UI-тестах выбирать самый стабильный локатор.

## 2026-01-24 — UIDevice в nonisolated контексте Swift 6
- Симптом: ошибка actor-изоляции.
- Корневая причина: `UIDevice.current` требует MainActor.
- Исправление: обертка с `nonisolated(unsafe)` и `MainActor.assumeIsolated`.
- Guardrail: явно документировать UI-зависимые nonisolated workaround.
